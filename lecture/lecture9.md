# 第9回 データベースの作成と接続・テーブル操作

ver1.0.1  
最終更新日: 2022年11月24日

---

## 目次

1. [既存のデータベースへの接続](#既存のデータベースへの接続)
2. [新規データベースの作成](#新規データベースの作成)
3. [テーブルの作成・変更・削除](#テーブルの作成変更削除)
4. [データの追加・更新・削除](#データの追加更新削除)
5. [（参考）トランザクション制御](#参考トランザクション制御)
6. [（参考）コマンドラインツールでの実行](#参考コマンドラインツールでの実行)

---

## 既存のデータベースへの接続

### データベースへの接続

**実務においては、すでに構築済みのデータベースに接続することが多い**

DB Browser for SQLite を使用し、データベースに接続する手順：

1. 講義資料にある `sample_db.sqlite3` をダウンロードし、任意のフォルダに移動する
2. DB Browser for SQLite を起動し、「データベースを開く」から `sample_db.sqlite3` を選択して開く

### データベース構造とテーブルの確認

**接続したデータベースの構造と、データベースにあるテーブルを確認する**

- 「データベース構造」タブの「テーブル」で、テーブルの一覧を参照できる
  - `sample_db.sqlite3` には `prefectures` というテーブルが存在することが確認できる
- 「データ閲覧」タブで、テーブルの内容を確認できる
  - `code` と `name` というカラムが存在し、データが格納されていることが確認できる

### データベースからの切断

**閲覧・編集したデータベースを閉じ、接続したデータベースから切断する**

- 「データベースを閉じる」を選択する
  - 編集を行った場合、保存するかどうかを確認されるので、必要な場合には保存する

---

## 新規データベースの作成

### 新規データベースの作成手順

**新しくデータベースを作成することができる**

1. DB Browser for SQLite を起動し、「新しいデータベース」を選択する
2. 任意の名前（例：`analytics.sqlite3`）をつけて「保存」を選択する
   - 日本語の名前を付けることもできるが、**英語の小文字で付けるようにする**
   - 拡張子は `.db`、`.sqlite`、`.sqlite3`、`.db3` のいずれかにする
3. 「テーブルの定義を編集」が出てくるので、「キャンセル」を選択する
   - テーブルの作成・削除については次章で扱う

---

## テーブルの作成・変更・削除

### SQLの種類

**本章ではデータ定義言語DDLを学ぶ**

| 種類 | 役割 | 例 |
|------|------|-----|
| **データ操作言語 (DML)** | テーブル内のデータの選択、登録、更新、削除などを行う | SELECT, INSERT, UPDATE, DELETE など |
| **データ定義言語 (DDL)** | テーブルの表の作成、削除、設定の変更などを行う | CREATE, DROP など |
| **データ制御言語 (DCL)** | 上記二つの利用権限を付与、削除などを行う | GRANT, REVOKE など |

### テーブルの作成

**テーブルを作成する場合には、CREATE TABLE を使用する**

#### 基本構文

```sql
CREATE TABLE テーブル名 (
    カラム名1 データ型 NOT NULL, 
    カラム名2 データ型,
    カラム名3 データ型, 
    ...
);
```

- SQLite ではデータ型の指定は必須ではない（ただし、指定したほうがわかりやすい）
- `NOT NULL` などの制約条件 (CONSTRAINT) を付与することもできる
- すでに存在するテーブルと同じ名前を付けようとするとエラーになる
  - `CREATE TABLE` の後に `IF NOT EXISTS` をつけることでエラーを回避できる

#### DB Browser for SQLite での実行方法

1. 「SQL実行」タブを選択
2. 配布資料の `user_mst.txt` を開き、前半部分を SQL 1 に貼り付ける
3. 「すべて/選択したSQLを実行」または「現在行を実行」を押す
   - `Ctrl + Enter` または `Shift + F5` で実行することもできる
4. 「エラーなしで実行が終了しました。」と出力されれば成功
   - 「データの閲覧」タブで空のテーブルができていることを確認する

#### GUIでのテーブル作成

DB Browser for SQLite ではテーブル作成のための SQL を自動で生成してくれる：

1. 「テーブルを作成」を選択
2. テーブル名を指定
3. 「フィールド」タブの「追加」を選択し、カラム名とデータ型を指定（制約条件を設定することも可能）
4. 「OK」を押すと、記載されている SQL が実行される

#### 変更の書き込み

**「変更を書き込み」を選択する**

- `CREATE TABLE` を実行しただけでは、データベースに処理が反映されない
- 「変更を書き込み」せずにデータベースを閉じると、テーブルは作成されないまま終了となる
- 「変更を書き込み」したかどうかは journalファイルの有無で確認することができる

### 使用可能なデータ型

**SQLite で使用可能なデータ型**

多くのデータベースでは、テーブル作成時にデータ型の指定が必須となるが、SQLite ではデータ型の指定は必須ではない（SQL から型を自動的に決定する）。

SQLite は他の SQL よりもデータ型が少ない（BOOLEAN や DATE などがない）。日付の処理は date関数等を利用して行う。

| データ型 | 意味 |
|----------|------|
| NULL | NULL値 |
| INTEGER | 符号付き整数 |
| REAL | 浮動小数点数 |
| TEXT | テキスト |
| BLOB | エンコードされない文字列 |

### コード系のカラムのデータ型についての注意点

**コード系のカラム（例：顧客ID・商品ID・カテゴリID）は必ずTEXT型とする**

CSVファイルを開いた場合、先頭に「0」がつくデータも数値型と解釈され、「0」が取れるので注意が必要。

コード系データは先頭に「0」がつくことがあるが、これを数値として読み込んでしまうと、「0」が削除されてしまう。他のデータと紐付ける際などに、紐付かなくなってしまう。

**例：**
- ❌ 郵便番号を INTEGER で保存: `640941` → 他テーブルの `0640941` と紐づけできない
- ⭕ 郵便番号を TEXT で保存: `0640941` → 正しく紐づけできる

### PRIMARY KEY（主キー）

**PRIMARY KEY（主キー）とは、テーブル内のレコードを一意（unique）に識別するためのカラムである**

- 値が重複するカラムやNULL値が入るカラムは指定できない
- DBによっては、複数のカラムの組み合わせに対してPRIMARY KEYを割り当てることも可能
  - Amazon Redshift では、PRIMARY KEYを複数のカラムに設定することはできない

**例（名簿テーブル）：**

| id | 名前 | 年齢 | 生年月日 | 住所コード |
|----|------|------|----------|------------|
| 1 | Taro | 18 | 1997-08-07 | 101 |
| 2 | Jiro | 16 | 1999-08-11 | 103 |
| 3 | Saburo | 30 | 1985-08-11 | 101 |
| 4 | Shiro | (null) | (null) | 105 |

- `id` → PRIMARY KEY として使用可能
- `住所コード` → 重複があるためPRIMARY KEYにできない
- `年齢`、`生年月日` → NULL値があるためPRIMARY KEYにできない

### テーブル定義の変更

**テーブル定義の変更は ALTER TABLE で行う**

カラムの追加は「ADD COLUMN」、削除は「DROP COLUMN」、名称変更は「RENAME COLUMN TO」を付ける。

#### 基本構文

```sql
-- 追加：ADD
ALTER TABLE テーブル名 ADD COLUMN カラム名;

-- 削除：DROP
ALTER TABLE テーブル名 DROP COLUMN カラム名;

-- 名称変更：RENAME TO
ALTER TABLE テーブル名 RENAME COLUMN カラム名 TO 新規カラム名;
```

※ PostgreSQL などでは「COLUMN」を書かなくても動作する

#### 実行例

`user_mst_tmp` に `gender` というカラムを追加する：

```sql
ALTER TABLE user_mst_tmp ADD COLUMN gender TEXT;
```

### テーブルの削除

**テーブルの削除は DROP TABLE で行う**

#### 基本構文

```sql
-- テーブル自体を削除（実行後、データもろともテーブルが消える）
DROP TABLE テーブル名;

-- テーブルの全データを削除（実行後、データはなくなるがテーブルは残る）
TRUNCATE TABLE テーブル名;
```

- 似た処理に `TRUNCATE TABLE` があるが、`DROP` は「テーブル自体を削除」、`TRUNCATE` は「テーブルの全レコードの削除」という点で異なる
- **SQLite では TRUNCATE TABLE の機能がないので注意**
- 誤って意図せぬデータを削除することによるリスクを考慮すると、通常の分析案件では上記2つは基本的に扱わない方がよい
- 存在しないテーブルを削除しようとするとエラーになる
  - `DROP TABLE` の後に `IF EXISTS` をつけることでエラーを回避できる

#### 実行例

```sql
DROP TABLE user_mst_tmp;
```

---

## データの追加・更新・削除

### データを追加する2つの方法

**テーブルにデータを追加するには、外部のファイルをインポートするか、INSERT文を利用する**

| インポート | INSERT文 |
|------------|----------|
| 外部のテキストファイルを読み込む | 2種類の方法がある |
| SQLite では `.import` コマンドを利用して読み込む | ① 既に登録済みデータを再利用する |
| DB Browser for SQLite では「インポート」を選択する | ② クエリにデータを直書きする |
| | データベースの中で完結する |

### データのインポート

**DB Browser for SQLite の「インポート」を使う**

1. 「ファイル」→「インポート」→「CSVファイルからテーブルへ」を選択
2. 読み込むCSVファイルを選択する
3. 「CSVファイルをインポート」の画面で区切り文字やエンコードを指定する
   - 今回は「先頭行をカラム名に」にチェックを入れない
4. 「名前が 'purchase' のテーブルは既に存在しています。データをこれにインポートしますか」と表示されるので「はい」を選択する
   - 「データの閲覧」タブでデータが追加されていることを確認する
5. 「変更を書き込み」を選択して処理を確定する

### データの追加（INSERT）

**データの追加は INSERT で行う**

追加する行の値を直に指定する場合は `VALUES` の後に1行ずつ括弧でくくり、他のテーブルの抽出結果を追加する場合は `VALUES` 以下を SELECT文に置き換える。

#### 基本構文

```sql
-- ① クエリに値を記入する方法
INSERT INTO テーブル名 [(カラム名1, カラム名2, ...)]
VALUES 
  (値1, 値2, ...)
, (値1, 値2, ...)
;

-- ② SELECT文の結果を挿入する方法
INSERT INTO テーブル名
SELECT カラム名
FROM テーブル名
;
```

※ すべてのカラムに値を設定する場合、テーブルのカラム名は省略可能

#### 実行例

```sql
INSERT INTO user_mst
VALUES
  ('1', '浅田平八', '男', 28, 'A', 182, 56, '東京都', 0, 350)
, ('2', '矢田まゆ', '女', 30, 'B', 165, 54, '神奈川県', 1, 280)
, ('3', '島田りさ', '女', 24, 'AB', 152, 39, '埼玉県', 0, 260)
, ('4', '水口五郎', '男', 35, 'O', 176, 68, '千葉県', 0, 580)
;
```

### データの更新と削除

**データの更新は UPDATE、削除は DELETE で行う**

- DB Browser for SQLite では「データ閲覧」から手動で更新・削除することもできる
- **データを恣意的に書き換えてはいけないため、データ分析では基本的にテーブルの更新や削除は行わない**

#### 基本構文

```sql
-- 更新：UPDATE
UPDATE テーブル名
SET カラム名 = 値
WHERE 条件式
;

-- 削除：DELETE
DELETE FROM テーブル名
WHERE 条件式
;
```

※ テーブルの全件削除は `TRUNCATE TABLE テーブル名` でも行える（削除するレコードの条件を指定しない場合、こちらの方が高速）

---

## 練習問題

### 練習問題1

`purchase.sql` を使い、`purchase` というテーブルを作成せよ

### 練習問題2

purchase テーブルに以下のデータを追加せよ。追加できたことが確認できたら、追加したデータを削除せよ。

```
'99', '11111', 2000, '2018-11-20', '2018-11-22'
```

### 章末課題

`analytics.sqlite3` において、以下のクエリを実行するとエラーになる。その理由を選択せよ。

```sql
DROP TABLE purchase_mst;
```

選択肢：
1. 一度作ったテーブルは削除できないため
2. purchase_mst というテーブルが存在しないため
3. テーブルを削除する権限がないため
4. クエリは1行で記述する必要があるため

---

## （参考）トランザクション制御

### COMMIT

**COMMITとは「INSERT、UPDATEのようなテーブル内容を変更する処理を確定する」ことである**

- `COMMIT` を実行しないと、それまでに流した INSERT文などの内容がテーブルに反映されない
  - テーブルが変更されていない、テーブルが作成されていないなどの場合、この観点を疑うとよい
  - DB Browser for SQLite では「変更を書き込み」を選択する（COMMIT文を書いても処理の確定が行われない）
- 既存テーブルに変化を加えずにデータを取得する SELECT文は、COMMIT を必要としない

#### 実行例

```sql
[INSERT / UPDATE / DELETE / DROP / CREATE] ...;
COMMIT;
```

### トランザクション

**トランザクションとは「COMMITが実行されるまでの、一連のSQLの処理」のことである**

- トランザクションが異常終了した場合、そのトランザクションの処理は無効となる
- トランザクションの途中で最後のCOMMITまでの処理を無効にする（切り戻す）場合、COMMITではなく「ROLLBACK」が使用される
  - ツールによっては自動で行われるものもある

**トランザクションの例：**

```
[トランザクション1]        [トランザクション2]        [トランザクション3]
SQL1 → SQL2 → SQL3 → COMMIT   SQL1 → COMMIT   SQL1 → SQL2(異常終了) → COMMIT
```

3つのトランザクションのうち、最後の3でコミット前に異常終了した場合：
- トランザクション1、2のSQLは全て正常に結果を返す
- トランザクション3で実行済みのSQL1、異常終了したSQL2はともに結果を返さない

※ トランザクションの開始位置を明確にするため、トランザクションの冒頭に `BEGIN TRANSACTION` と書くこともある

---

## （参考）コマンドラインツールでの実行

**授業で扱った内容をコマンドツールを使って実行する方法**

コマンドプロンプトを起動し、以下のコマンドを入力する：

```bash
cd Desktop\sqlite3              # フォルダの移動
sqlite3 analytics_cmd.sqlite3   # データベース作成
.read purchase.sql              # ファイルを読み込んでテーブル作成
.table                          # テーブルの確認
.mode csv                       # モードの変更
.import purchase.csv purchase   # CSVの読み込み
.exit                           # 終了
```

※ DB Browser for SQLite 等のツールを使った方がテーブルの確認が容易にできる

---

Copyright © 2023 Accenture. All rights reserved.