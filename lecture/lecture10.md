# 第10回 データの抽出

ver1.0.1  
最終更新日: 2022年11月29日

---

## 目次

### データの抽出
- SQLのルール
- SELECT文
- SELECT句・FROM句
- LIMIT

### 条件によるデータの抽出
- WHERE句
- BETWEEN
- LIKE
- IN
- NULL値による抽出

### ソート

---

## データの抽出

### SQLのルール

#### ① 実行時の基本

- インデントや改行により、他の人にも読みやすいSQLを心がける
- 1つのSQL文の終わりには、「`;`」をつける

**良い例:**
```sql
SELECT
    user_name
    ,age
    ,salary
FROM
    user_mst
WHERE
    gender = '男'
    AND height >= 175
    AND salary > 400
;
```

**悪い例:**
```sql
SELECT user_name, 
age, salary FROM 
user_mst
WHERE gender = '男'
AND height >= 175 
AND salary > 400;
```

> 長く複雑な処理を実行するSQLは、こまめに改行しないと読みづらい

#### ② コメントアウト

- 他人と共有するSQLには、自分用のメモなどの余計なコメントは残さない
- SQLでのコメントアウトは 1行の場合「`--`」、複数行の場合「`/* */`」で行う

**1行のみコメントアウト:**
```sql
SELECT
    カラム1
    , カラム2
    -- , カラム3
FROM
    テーブル名
;
```

**複数行のコメントアウト:**
```sql
SELECT
    カラム1
    /*, カラム2
    , カラム3*/
FROM
    テーブル名
;
```

> 1つのSQLファイルにつき複数行をコメントアウトすると、「閉じ忘れ」のミスが生じやすい。「文法上間違っていないのにエラーが出る」場合のチェック観点として覚えておくとよい。

---

### SELECT文

#### SQLの種類

本章ではデータ操作言語DMLを学ぶ。

| 種類 | 役割 | 例 |
|------|------|-----|
| データ操作言語 (DML: Data Manipulation Language) | テーブル内のデータの選択、登録、更新、削除などを行う | SELECT(選択), INSERT(挿入), UPDATE(更新), DELETE(削除)など |
| データ定義言語 (DDL: Data Definition Language) | テーブルの表の作成、削除、設定の変更などを行う | CREATE(テーブル作成), DROP(テーブル削除)など |
| データ制御言語 (DCL: Data Control Language) | 上記二つの利用権限を付与、削除などを行う | GRANT(権限付与), REVOKE(権限削除)など |

#### SELECT文とは

- 様々な条件を指定してデータを抽出できる
- 抽出時にデータの加工や集計なども行うことができる
- SELECT文を **クエリ(=Query)** と呼ぶこともある

**SELECT文の例:**  
「会員」テーブルから、都道府県別に平均年収を計算し、平均年収が330以上の都道府県を抽出する

```sql
SELECT
    addr
    ,AVG(salary) AS 平均年収
FROM 
    user_mst
GROUP BY 
    addr
HAVING 
    AVG(salary) >= 330
;
```

#### 構成句の一覧

- SELECT文の基本となる構成句なので、並び順と役割は覚える必要がある
- 構成句の並び順は変更できない
- クエリを記述する際は、内部処理順で記述すると考えやすい

| 構成句（並び順） | 役割 | 内部処理順 |
|-----------------|------|-----------|
| SELECT | 表示するカラムを指定 | 6 |
| FROM | 参照元のテーブルを指定 | 1 |
| JOIN | 複数のテーブルを横結合 | 2 |
| WHERE | 条件抽出 | 3 |
| GROUP BY | 集約関数の集計単位を指定 | 4 |
| HAVING | 集約関数を使い条件抽出 | 5 |
| ORDER BY | 表示するデータの順番を並び替え | 7 |
| LIMIT | 表示するデータ数を制限 | 8 |

---

### SELECT句・FROM句

- **SELECT句**: 表示するカラム名を指定する
- **FROM句**: 参照元のテーブル名を指定する
- SELECT句・FROM句は、SELECT文では必須である2つの構成句

**基本構文:**
```sql
SELECT 
    カラム名
FROM 
    テーブル名
;
```

**練習:** 「会員」テーブルから「性別」、「血液型」、「年収」を表示する

```sql
SELECT
    gender
    ,blood
    ,salary
FROM
    user_mst
;
```

#### 全カラムの抽出（アスタリスク）

`*`（アスタリスク）を使うことで、該当テーブルの全カラムを抽出できる。

```sql
SELECT
    *
FROM 
    user_mst
;
```

#### 一時的な名称変更（AS）

「AS」を使って抽出されたデータのカラム名、テーブル名を変更できる。

- 長い名称の省略、関数などで処理済みのカラムへの名称の付与などが可能
- あくまでも「抽出されたデータ内での名称変更」なので、元のテーブルのカラムやテーブルの名称が変更されるわけではない

**基本構文:**
```sql
SELECT
    カラム名 AS 新規カラム名
FROM
    テーブル名
;
```

**例:**
```sql
SELECT
    user_name AS full_name
FROM
    user_mst
;
```

#### DISTINCT（重複排除）

DISTINCTによって、レコードの重複を排除することができる。

- 抽出するカラム全てについて重複を判定する
- 応用例として、COUNT関数とDISTINCTを併用することもできる  
  例: `SELECT COUNT(DISTINCT カラム名) FROM テーブル名;`

**基本構文:**
```sql
SELECT
    DISTINCT カラム名
FROM 
    テーブル名
;
```

**例:** 会員テーブルから、重複を除いた住所を抽出する

```sql
SELECT 
    DISTINCT addr
FROM 
    user_mst
;
```

---

### LIMIT

LIMITを使うと、任意のレコード数だけ抽出できる。

- 抽出後のレコード数が非常に大きい場合、LIMITで行数を指定しないと固まってしまうことがある

**基本構文:**
```sql
SELECT
    カラム名
FROM
    テーブル名
LIMIT 表示させたいレコード数
;
```

**例:** 「会員」テーブルを10行だけ表示する

```sql
SELECT
    *
FROM
    user_mst
LIMIT 10
;
```

---

## 条件によるデータの抽出

### WHERE句

WHERE句を使うと、指定した条件に合致するレコードだけ抽出できる。

**基本構文:**
```sql
SELECT
    カラム名
FROM
    テーブル名
WHERE
    条件式
;
```

**基本的な演算子:**

| 演算子 | 意味 | 例 |
|--------|------|-----|
| = | 等しい | age = 20 |
| > | より大きい | age > 20 |
| >= | 以上 | age >= 20 |
| < | より小さい | age < 20 |
| <= | 以下 | age <= 20 |
| <> | 等しくない | age <> 20 |

> SQLite では 「等しい」として 「==」、「等しくない」として「!=」を使うこともできる

**例:** 「会員」テーブルから20歳以上の人の「性別」、「年齢」、「血液型」、「年収」を表示する

```sql
SELECT
    gender
    , age
    , blood
    , salary
FROM
    user_mst
WHERE
    age >= 20
;
```

#### 複数条件指定（AND / OR）

WHERE句ではAND／OR条件を組み合わせて、複数条件を指定できる。

- **AND条件**: 「かつ」
- **OR条件**: 「または」
- 複数カラムにそれぞれ条件指定することも可能
- 複数条件の指定時には、括弧でくくることで条件の適用範囲を明確にできる

**例:** 会員テーブルから20代の人の名前を抽出する

```sql
SELECT
    user_name
FROM
    user_mst
WHERE age >= 20
    AND age < 30
;
```

---

### BETWEEN

数値型や日付型のカラムであれば、BETWEENを用いて範囲を指定できる。

以下の構文では、「条件指定するカラム」が A以上B以下 のレコードを抽出する。

**基本構文:**
```sql
SELECT
    カラム名
FROM
    テーブル名
WHERE
    カラム名 BETWEEN A AND B
;
```

**例:** 会員テーブルから20代の人の名前を抽出する

```sql
SELECT
    user_name
FROM
    user_mst
WHERE
    age BETWEEN 20 AND 29
;
```

> 下記の記述と同条件: `(age >= 20) AND (age <= 29)`

---

### LIKE

LIKEを使うことで、任意の文字列を「`%`」で表してレコードを抽出できる。

- 前方一致や後方一致、部分一致で文字列を検索できる
- 「=」で条件指定する場合と比べ、検索速度が劣化しやすい

**基本構文:**
```sql
SELECT
    カラム名
FROM
    テーブル名
WHERE
    対象カラム名 LIKE 'xxx%yyy'
;
```

> 指定したカラムに対して「『xxx』から始まり『yyy』で終わる」文字列を持つレコードが抽出される

**例:** 「会員」テーブルから、居住する「住所」が「県」の会員を抽出する

```sql
SELECT
    *
FROM
    user_mst
WHERE
    addr LIKE '%県'
;
```

---

### IN

INを使うことで、対象のカラムに対して複数の条件を指定できる。

#### 一つのカラムに複数条件

```sql
SELECT
    カラム名
FROM
    テーブル名
WHERE
    対象カラム IN (条件1, 条件2)
;
```

> 下記の記述と同条件: `(カラム=条件1) OR (カラム=条件２)`

**例:** 「会員」テーブルから「住所」が'東京都'または'神奈川県'の人を抽出する

```sql
SELECT *
FROM user_mst
WHERE
    addr IN ('東京都', '神奈川県')
;
```

#### 複数のカラムに複数条件

```sql
SELECT
    カラム名
FROM
    テーブル名
WHERE
    (カラム1, カラム2) IN (
        (カラム１条件1, カラム2条件1)
        ,(カラム１条件2, カラム2条件2) 
    )
;
```

> 複数のカラムに複数条件の組み合わせを指定する場合、AND条件となる

> ただし、SQLite では対応していない

> INの条件として副問い合わせを使用することもできる

**例:** 「会員」テーブルから、「結婚回数」が１回の女性、または「結婚回数」が２回の男性を抽出する

```sql
SELECT *
FROM user_mst
WHERE
    (gender, marriage) IN (
        ('女', 1)
        ,('男', 2)
    )
;
```

---

### NULL値による抽出

任意のカラムがNULLであるレコードを抽出する場合、`カラム名 IS NULL` と書く。

> NULLに対してイコールは使用できない

**基本構文:**
```sql
SELECT
    カラム名
FROM
    テーブル名
WHERE
    カラム名 IS NULL
;
```

`カラム名 IS NOT NULL` とすることで、任意のカラムがNULLでないレコードを抽出できる。

**例:** 「購買」テーブルから、「受取日」がNULLでないデータを表示する

```sql
SELECT
    *
FROM
    purchase
WHERE
    receive_dt IS NOT NULL
;
```

#### NULL値と空文字の違い

NULL値と空文字はデータベースの種類によって扱いが異なる。

- **NULL値**: データが存在しないことを指す → 「IS NULL」を指定して抽出する
- **空文字**: 長さ 0 の文字列 → 文字を1つも含まないが、データは存在している

**データ追加時の注意点:**
- csvファイル中の空のセルは、デフォルトでNULLとしてみなされる
- csvファイル中に「NULL」や「NA」とあるものは、文字列とみなされる
- INSERT文でデータを挿入する場合、「NULL」と入力するとNULL値を入力できる

---

## ソート

### ORDER BY 句

任意のカラムについて、昇順（ASC）・降順（DESC）に並び替えて抽出する際に使用する。

- カラム名の後に何も記載しないと昇順に並び替えられるが、読みやすさのため明示的に ASC を付与することを推奨する

**基本構文:**
```sql
SELECT
    カラム名
FROM
    テーブル名
ORDER BY
    ソートのキーとするカラム名
    ASC / DESC
;
```

**例:** 「会員」テーブルを、「年齢」が高い順に並び替える

```sql
SELECT
    *
FROM
    user_mst
ORDER BY
    age DESC
;
```

#### 複数指定

**例:** 「会員」テーブルを、「年齢」が若く、「年収」が高い順に並び替える

```sql
SELECT
    *
FROM
    user_mst
ORDER BY
    age ASC
    , salary DESC
;
```

> 年齢の昇順→年収の降順。そのため、年齢が同一のデータは年収が降順になっている。

---

## 練習問題

### 練習問題1: BETWEEN

「会員」テーブルから、「10代」で「身長」160cm以上の人、または「30代」の「未婚者」を抽出せよ

**ヒント:** WHERE句でAND条件・OR条件を扱う

### 練習問題2: ORDER BY

「会員」テーブルを「身長」で小さい順に並べ、上位5人の「個人ID」、「名前」、「性別」、「身長」、「体重」を出力せよ

**ヒント:** ORDER BY を使う

---

## 章末課題

「会員」テーブルから「坂本卓也」のレコードのみを抽出するクエリとして正しくないものを選択せよ

**①**
```sql
SELECT
    *
FROM
    user_mst
WHERE
    salary > 700
;
```

**②**
```sql
SELECT
    *
FROM
    user_mst
WHERE
    marriage > 1
;
```

**③**
```sql
SELECT
    *
FROM
    user_mst
WHERE
    user_name LIKE '坂本%'
    AND user_id = '12' 
;
```

**④**
```sql
SELECT
    *
FROM
    user_mst
WHERE
    gender = '男'
    AND age BETWEEN 30 AND 39 
;
```

---

## サンプルデータ

### 会員(user_mst)テーブル

| 個人ID | 名前 | 性別 | 年齢 | 血液型 | 身長 | 体重 | 住所 | 結婚回数 | 年収 |
|--------|------|------|------|--------|------|------|------|----------|------|
| 1 | 浅田平八 | 男 | 28 | A | 182 | 56 | 東京都 | 0 | 350 |
| 2 | 矢田まゆ | 女 | 30 | B | 165 | 54 | 神奈川県 | 1 | 280 |
| 3 | 島田りさ | 女 | 24 | AB | 152 | 39 | 埼玉県 | 0 | 260 |
| 4 | 水口五郎 | 男 | 35 | O | 176 | 68 | 千葉県 | 0 | 580 |
| 5 | 大和慶事 | 男 | 22 | B | 185 | 73 | 茨城県 | 0 | 320 |
| 6 | 高島亜里沙 | 女 | 18 | O | 148 | 41 | 東京都 | 0 | 95 |
| 7 | 安田紗江 | 女 | 28 | A | 154 | 47 | 埼玉県 | 0 | 290 |
| 8 | 田村哲平 | 男 | 32 | A | 178 | 69 | 神奈川県 | 0 | 520 |
| 9 | 五十嵐涼子 | 女 | 29 | B | 162 | 45 | 埼玉県 | 1 | 490 |
| 10 | 神田洋介 | 男 | 25 | O | 171 | 63 | 東京都 | 0 | 330 |
| 11 | 山口美穂 | 女 | 19 | AB | 169 | 49 | 千葉県 | 0 | 240 |
| 12 | 坂本卓也 | 男 | 39 | A | 164 | 59 | 神奈川県 | 2 | 720 |
| 13 | 辻本隼 | 男 | 26 | O | 156 | 65 | 東京都 | 0 | 430 |
| 14 | 君島理恵 | 女 | 27 | B | 155 | 42 | 千葉県 | 0 | 210 |
| 15 | 小池隆二 | 男 | 24 | A | 153 | 53 | 神奈川県 | 0 | 600 |

### 購買(purchase)テーブル

| 個人ID | 購買ID | 合計金額 | 注文日 | 受取日 |
|--------|--------|----------|--------|--------|
| 10 | 10001 | 5000 | 2017-11-01 | 2017-11-04 |
| 14 | 10002 | 10000 | 2017-11-02 | 2017-11-05 |
| 8 | 10003 | 3000 | 2017-11-02 | 2017-11-05 |
| 6 | 10005 | 3500 | 2017-11-04 | 2017-11-07 |
| 10 | 10006 | 5000 | 2017-11-05 | 2017-11-08 |
| 6 | 10007 | 8000 | 2017-11-07 | 2017-11-10 |
| 5 | 10009 | 3000 | 2017-11-12 | 2017-11-15 |
| 3 | 10010 | 9000 | 2017-11-12 | 2017-11-15 |
| 17 | 10012 | 10000 | 2017-11-15 | 2017-11-18 |