# 第14回 PythonとSQLiteの連携

ver1.0  
最終更新日: 2021年12月28日

---

## 目次

1. [sqlite3モジュールを使ったPythonとSQLiteの連携](#sqlite3モジュールを使ったpythonとsqliteの連携)
2. [後半レポート](#後半レポート)
3. [終わりに](#終わりに)

---

## sqlite3モジュールを使ったPythonとSQLiteの連携

### sqlite3モジュール

sqlite3モジュールを使うことで、Google Colaboratory で SQLiteのデータベースを操作することができるようになる。

- sqlite3モジュールは標準ライブラリに含まれるため、インストール不要で利用することができる
  - 公式ドキュメント：https://docs.python.org/ja/3/library/sqlite3.html
- データベースを新規作成したり、作成済みのデータベースに接続することができる
  - 今回は `analytics.sqlite3` を Google Drive にアップロードして接続する
- 新規ノートブックを作成し、sqlite3 と pandas を import しておく

```python
import sqlite3
import pandas as pd
```

---

### データベースへの接続

**connect() 関数を利用してデータベースに接続する**

以下の手順でデータベースに接続する：

1. Google Drive をマウントする
   - 「このノートブックに Google ドライブのファイルへのアクセスを許可しますか？」と表示される場合、「Google ドライブに接続」を選択する
2. `analytics.sqlite3` を格納したフォルダのパスを取得し、変数に格納しておく
3. データベース名を変数に格納しておく
4. `connect()` メソッドを使って接続する

エラーが出なければ正しく接続できている。

**使用例：**

```python
db_path = '/content/drive/MyDrive/AI・データサイエンスツールⅣ/'  # ②
db_name = 'analytics.sqlite3'  # ③
conn = sqlite3.connect(db_path + db_name)  # ④
```

---

### データの取得 (1/2)

**cursor() メソッドを利用してカーソルオブジェクトを作成する**

カーソルオブジェクトの `execute()` メソッドによりクエリを実行する。

```python
cur = conn.cursor()
sql_query = 'SELECT * FROM user_mst;'
cur.execute(sql_query)
```

**実行結果：**

```
<sqlite3.Cursor at 0x7f45421a2ea0>
```

---

### データの取得 (2/2)

**fetchone() メソッド等を利用してデータを取得する**

fetch（読み込む、取ってくる）に関連する3つのメソッドが存在する：

| メソッド | 説明 |
|----------|------|
| `fetchone()` | 1レコードを取得する |
| `fetchmany(size)` | size引数で指定した数のレコードを取得する |
| `fetchall()` | 全ての（残りの）レコードを取得する |

戻り値はタプル、またはタプルのリストになる。

**使用例：**

```python
cur.fetchone()      # ①
cur.fetchmany(2)    # ②
cur.fetchall()      # ③
```

**実行結果：**

```python
# ① fetchone()
('1', '浅田平八', '男', 28, 'A', 182, 56, '東京都', 0, 350)

# ② fetchmany(2)
[('2', '矢田まゆ', '女', 30, 'B', 165, 54, '神奈川県', 1, 280),
 ('3', '島田りさ', '女', 24, 'AB', 152, 39, '埼玉県', 0, 260)]

# ③ fetchall()
[('4', '水口五郎', '男', 35, 'O', 176, 68, '千葉県', 0, 580),
 ('5', '大和慶事', '男', 22, 'B', 185, 73, '茨城県', 0, 320),
 ('6', '高島亜里沙', '女', 18, 'O', 148, 41, '東京都', 0, 95),
 # (以下略)
]
```

**イメージ：**

```
1 浅田平八    ← ①
2 矢田まゆ    ← ②
3 島田りさ    ← ②
4 水口五郎    ← ③
5 大和慶事    ← ③
```

---

### pandas を使ったデータ取得

**pandas の read_sql() 関数を利用すると、データベースのデータをデータフレームに読み込むことができる**

データ取得後の加工がしやすい。

**使用例：**

```python
sql_query = 'SELECT * FROM user_mst LIMIT 5;'
df = pd.read_sql(sql_query, conn)
df
```

**実行結果：**

|   | user_id | user_name | gender | age | blood | height | weight | addr | marriage | salary |
|---|---------|-----------|--------|-----|-------|--------|--------|------|----------|--------|
| 0 | 1 | 浅田平八 | 男 | 28 | A | 182 | 56 | 東京都 | 0 | 350 |
| 1 | 2 | 矢田まゆ | 女 | 30 | B | 165 | 54 | 神奈川県 | 1 | 280 |
| 2 | 3 | 島田りさ | 女 | 24 | AB | 152 | 39 | 埼玉県 | 0 | 260 |
| 3 | 4 | 水口五郎 | 男 | 35 | O | 176 | 68 | 千葉県 | 0 | 580 |
| 4 | 5 | 大和慶事 | 男 | 22 | B | 185 | 73 | 茨城県 | 0 | 320 |

---

### データベースからの切断

**使用後はデータベースからの接続を切断しておく**

切断の際は `close()` メソッドを利用する。切断しない場合、メモリを消費してしまう。

**使用例：**

```python
conn.close()
```

---

## 練習問題

### 練習問題①

**問題：**「会員」テーブルの「性別」ごとに平均年収を算出せよ

**【会員(user_mst)テーブル】**

| 個人ID | 名前 | 性別 | 年齢 | 血液型 | 身長 | 体重 | 住所 | 結婚回数 | 年収 |
|--------|------|------|------|--------|------|------|------|----------|------|
| user_id | user_name | gender | age | blood | height | weight | addr | marriage | salary |
| 1 | 浅田平八 | 男 | 28 | A | 182 | 56 | 東京都 | 0 | 350 |
| 2 | 矢田まゆ | 女 | 30 | B | 165 | 54 | 神奈川県 | 1 | 280 |
| 3 | 島田りさ | 女 | 24 | AB | 152 | 39 | 埼玉県 | 0 | 260 |
| 4 | 水口五郎 | 男 | 35 | O | 176 | 68 | 千葉県 | 0 | 580 |
| 5 | 大和慶事 | 男 | 22 | B | 185 | 73 | 茨城県 | 0 | 320 |
| 6 | 高島亜里沙 | 女 | 18 | O | 148 | 41 | 東京都 | 0 | 95 |
| 7 | 安田紗江 | 女 | 28 | A | 154 | 47 | 埼玉県 | 0 | 290 |
| 8 | 田村哲平 | 男 | 32 | A | 178 | 69 | 神奈川県 | 0 | 520 |
| 9 | 五十嵐涼子 | 女 | 29 | B | 162 | 45 | 埼玉県 | 1 | 490 |
| 10 | 神田洋介 | 男 | 25 | O | 171 | 63 | 東京都 | 0 | 330 |
| 11 | 山口美穂 | 女 | 19 | AB | 169 | 49 | 千葉県 | 0 | 240 |
| 12 | 坂本卓也 | 男 | 39 | A | 164 | 59 | 神奈川県 | 2 | 720 |
| 13 | 辻本隼 | 男 | 26 | O | 156 | 65 | 東京都 | 0 | 430 |
| 14 | 君島理恵 | 女 | 27 | B | 155 | 42 | 千葉県 | 0 | 210 |
| 15 | 小池隆二 | 男 | 24 | A | 153 | 53 | 神奈川県 | 0 | 600 |

---

#### 練習問題①の解答と解説

**解答：**

```python
sql_query = '''
SELECT gender, AVG(salary) AS avg_salary
FROM user_mst
GROUP BY gender;
'''
df = pd.read_sql(sql_query, conn)
df
```

**解説：**

この問題では、性別ごとにグループ化して平均年収を計算する必要があります。

1. **`GROUP BY gender`**: 性別（gender）でデータをグループ化します
2. **`AVG(salary)`**: 各グループの年収（salary）の平均を計算します
3. **`AS avg_salary`**: 結果のカラムに「avg_salary」という別名を付けます

**実行結果の例：**

| gender | avg_salary |
|--------|------------|
| 女 | 266.428571 |
| 男 | 478.750000 |

**ポイント：**
- `GROUP BY` 句を使うことで、指定したカラムの値ごとにデータを集約できます
- 集約関数（`AVG`, `SUM`, `COUNT`, `MAX`, `MIN`など）と組み合わせて使用します

---

### 練習問題②

**問題：**「会員」テーブルから「未婚」の人の「性別」、「住所」別の「平均年収」を求めよ

---

#### 練習問題②の解答と解説

**解答：**

```python
sql_query = '''
SELECT gender, addr, AVG(salary) AS avg_salary
FROM user_mst
WHERE marriage = 0
GROUP BY gender, addr;
'''
df = pd.read_sql(sql_query, conn)
df
```

**解説：**

この問題では、未婚者に絞り込んでから、性別と住所の組み合わせごとに平均年収を計算します。

1. **`WHERE marriage = 0`**: 未婚（結婚回数が0）の人のみを抽出します
2. **`GROUP BY gender, addr`**: 性別と住所の組み合わせでグループ化します
3. **`AVG(salary)`**: 各グループの平均年収を計算します

**実行結果の例：**

| gender | addr | avg_salary |
|--------|------|------------|
| 女 | 千葉県 | 225.0 |
| 女 | 埼玉県 | 275.0 |
| 女 | 東京都 | 95.0 |
| 男 | 千葉県 | 580.0 |
| 男 | 東京都 | 370.0 |
| 男 | 神奈川県 | 560.0 |
| 男 | 茨城県 | 320.0 |

**ポイント：**
- `WHERE`句は`GROUP BY`句より前に記述します（SQL文の実行順序）
- 複数のカラムでグループ化する場合は、カンマ区切りで列挙します
- `marriage = 0` は「未婚」を意味します（結婚回数が0回）

---

## 章末課題

**問題：**「会員」テーブルの「年齢」に単位を付けて「〇歳」と出力するコードをPythonで書く場合、以下の□に当てはまるコードとして正しいものを選択せよ

```python
user_mst = pd.read_sql('SELECT * FROM user_mst;', conn)
□
```

**選択肢：**

1. `user_mst['age'] + '歳'`
2. `cast(user_mst['age'], 'str') + '歳'`
3. `user_mst['age'] + int('歳')`
4. `user_mst['age'].astype('str') + '歳'`

---

### 章末課題の解答と解説

**正解：④ `user_mst['age'].astype('str') + '歳'`**

**解説：**

この問題のポイントは、数値型と文字列型の連結方法を理解しているかどうかです。

**各選択肢の解説：**

| 選択肢 | 結果 | 理由 |
|--------|------|------|
| ① `user_mst['age'] + '歳'` | エラー | 数値型（int）と文字列型（str）は直接連結できません |
| ② `cast(user_mst['age'], 'str') + '歳'` | エラー | `cast`はPythonの組み込み関数ではありません（SQLの関数です） |
| ③ `user_mst['age'] + int('歳')` | エラー | `'歳'`を整数に変換することはできません |
| ④ `user_mst['age'].astype('str') + '歳'` | 正常動作 | `astype()`メソッドで数値を文字列に変換してから連結 |

**`astype()`メソッドについて：**

- pandasのSeriesやDataFrameのデータ型を変換するメソッドです
- `astype('str')` で数値型を文字列型に変換できます
- 文字列に変換後は `+` 演算子で文字列連結が可能になります

**実行結果の例：**

```python
user_mst['age'].astype('str') + '歳'
```

```
0     28歳
1     30歳
2     24歳
3     35歳
4     22歳
...
```

---

## 後半レポート

### 後半レポートについて

コンテンツにある「後半レポートについて」をよく読んで回答してください。

**⚠️ 注意事項**

> 6つの小課題のうち、1つでも未提出の場合はレポートを提出しても単位認定しません。  
> （※小課題は正解するまで提出とはみなされません）

---

## 終わりに

### データサイエンスに必要なスキルとツール

**データサイエンスでは様々なスキルが要求される**

#### データサイエンティストに求められるスキルセット

```
         ビジネス力
           /    \
          /      \
         /        \
   データ    ―――    データ
サイエンス力      エンジニア力
```

※ 一般社団法人データサイエンティスト協会の資料を参考に作成

#### スキルとツールの具体例

| 分野 | 内容 |
|------|------|
| **数学** | 統計学、確率、線形代数 など |
| **プログラミング** | Python、R、SAS など |
| **大規模データ処理** | SQL、Hive、Spark など |
| **機械学習** | 教師あり学習、教師なし学習、強化学習 など |
| **可視化** | Tableau、PowerBI など |
| **データラングリング** | クレンジング、整形 など |
| **ビジネスの洞察力** | 課題の理解、コミュニケーション など |

> **メモ**  
> 近年ではノーコード・ローコードと呼ばれるGUIベースのツールの数も増えている

---

### さらに学びたい人のために

**自分で勉強したい人向けの推奨書籍を紹介する**

#### Python / プログラミング

- みんなのPython
- Pythonによるデータ分析入門
- Effective Python（中級者向け）
- リーダブルコード（中級者向け）

#### SQL

- データ集計・分析のためのSQL入門
- ビッグデータ分析・活用のためのSQLレシピ
- 達人に学ぶSQL徹底指南書（中級者向け）

#### 統計学・機械学習

- Pythonで学ぶあたらしい統計学の教科書
- 統計学入門（中級者向け）
- はじめてのパターン認識（中級者向け）

#### データサイエンス全般

- データサイエンティスト養成読本 登竜門編
- 最強のデータ分析組織

---

## まとめ

本講義で学んだ重要なポイント：

1. **sqlite3モジュール**は標準ライブラリに含まれており、インストール不要でSQLiteを操作できる
2. **connect()** でデータベースに接続し、**cursor()** でカーソルオブジェクトを作成する
3. **execute()** でSQLクエリを実行し、**fetch系メソッド**でデータを取得する
4. **pandas.read_sql()** を使うと、結果を直接DataFrameとして取得でき、加工しやすい
5. 使用後は **close()** でデータベース接続を切断することを忘れない
6. **astype()** メソッドで型変換を行い、異なる型のデータを連結できる

---

*Copyright © 2023 Accenture. All rights reserved.*